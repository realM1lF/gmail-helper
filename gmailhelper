#!/bin/bash
#
# Gmail Helper - Unified CLI
# Usage: gmailhelper [command] [options]
#

set -e

# =============================================================================
# Pfad-Konfiguration (Symlink-sicher)
# =============================================================================
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

PROJECT_ROOT="$SCRIPT_DIR"
VENV_PYTHON="$PROJECT_ROOT/.venv/bin/python"
MAIN_PY="$PROJECT_ROOT/app/main.py"
LAUNCHER="$PROJECT_ROOT/launcher.py"

# =============================================================================
# Farben f√ºr Output
# =============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

# =============================================================================
# Hilfsfunktionen
# =============================================================================

check_venv() {
    if [ ! -f "$VENV_PYTHON" ]; then
        echo -e "${RED}‚ùå Fehler: Python-Venv nicht gefunden in $PROJECT_ROOT/.venv${NC}"
        echo "   Bitte zuerst ausf√ºhren: pip install -r requirements.txt"
        exit 1
    fi
}

check_ollama() {
    if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

get_ollama_model() {
    curl -s http://localhost:11434/api/tags 2>/dev/null | grep -o '"name":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "unbekannt"
}

show_help() {
    cat << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    Gmail Helper CLI                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

USAGE:
    gmailhelper [command] [options]

COMMANDS:
    setup               Erstinstallation durchf√ºhren
    setup --reset       Einstellungen √§ndern (Token bleibt erhalten)
    run --test          Test-Modus: Einmaliger Dry-Run
    run --live          Live-Modus: Dauerlauf (alle 30 Sekunden)
    stop                Stoppt alle laufenden Gmail Helper Prozesse
    status              Zeigt System-Status an
    help                Zeigt diese Hilfe an

BEISPIELE:
    gmailhelper                 # Willkommensbildschirm anzeigen
    gmailhelper setup           # Erstinstallation
    gmailhelper setup --reset   # Einstellungen √§ndern
    gmailhelper run --test      # Testlauf (zeigt nur an, setzt keine Labels)
    gmailhelper run --live      # Dauerlauf (labels setzen, alle 30s)
    gmailhelper stop            # Alle Prozesse stoppen
    gmailhelper status          # Status von Ollama, Config, etc.
    gmailhelper help            # Diese Hilfe

ZUS√ÑTZLICHE OPTIONEN (f√ºr run --test / run --live):
    --max-results N     Maximale Anzahl E-Mails (default: 20)
    --q "query"         Benutzerdefinierte Gmail-Query

EOF
}

get_system_info() {
    # RAM
    local TOTAL_RAM=""
    if command -v sysctl &>/dev/null; then
        # macOS
        TOTAL_RAM=$(sysctl -n hw.memsize 2>/dev/null | awk '{print int($1/1024/1024/1024) " GB"}')
    elif [ -f /proc/meminfo ]; then
        # Linux
        TOTAL_RAM=$(grep MemTotal /proc/meminfo 2>/dev/null | awk '{print int($2/1024/1024) " GB"}')
    fi
    echo "$TOTAL_RAM"
}

show_system_requirements() {
    echo -e "   ${BOLD}Systemanforderungen:${NC}\n"
    echo -e "   ${DIM}Minimal:${NC}              8 GB RAM, 10 GB freier Speicher"
    echo -e "   ${DIM}Empfohlen:${NC}            16 GB RAM, 15 GB freier Speicher"
    echo -e "   ${DIM}Betriebssystem:${NC}       macOS 12+ oder Linux (Ubuntu 20.04+)"
    echo -e "   ${DIM}KI-Modell:${NC}            mistral:7b-instruct (~4.4 GB)"
    echo -e "   ${DIM}Internet:${NC}             Erforderlich f√ºr Download & Gmail API"
    echo ""
    
    # Aktuelle System-Info anzeigen
    local CURRENT_RAM=$(get_system_info)
    local CURRENT_OS=""
    if [[ "$OSTYPE" == "darwin"* ]]; then
        CURRENT_OS=$(sw_vers -productVersion 2>/dev/null | cut -d. -f1,2 || echo "macOS")
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        CURRENT_OS=$(lsb_release -d 2>/dev/null | cut -f2 || echo "Linux")
    fi
    
    if [ -n "$CURRENT_RAM" ] || [ -n "$CURRENT_OS" ]; then
        echo -e "   ${BOLD}Dein System:${NC}\n"
        [ -n "$CURRENT_OS" ] && echo -e "   ${DIM}Betriebssystem:${NC}       $CURRENT_OS"
        [ -n "$CURRENT_RAM" ] && echo -e "   ${DIM}RAM:${NC}                  $CURRENT_RAM"
        
        # Warnung bei wenig RAM
        if [ -n "$CURRENT_RAM" ]; then
            local RAM_GB=$(echo "$CURRENT_RAM" | grep -o '[0-9]*' | head -1)
            if [ "$RAM_GB" -lt 8 ] 2>/dev/null; then
                echo -e "   ${YELLOW}‚ö†Ô∏è  WARNUNG: Wenig RAM - Modell l√§uft m√∂glicherweise langsam${NC}"
            elif [ "$RAM_GB" -lt 16 ] 2>/dev/null; then
                echo -e "   ${GREEN}‚úÖ RAM ausreichend f√ºr Standard-Betrieb${NC}"
            else
                echo -e "   ${GREEN}‚úÖ Optimal f√ºr fl√ºssige Performance${NC}"
            fi
        fi
        echo ""
    fi
}

show_welcome() {
    # Pr√ºfe Setup-Status
    local SETUP_COMPLETE=true
    local MISSING_ITEMS=""
    
    if [ ! -f "$PROJECT_ROOT/.venv/bin/python" ]; then
        SETUP_COMPLETE=false
        MISSING_ITEMS="${MISSING_ITEMS}\n   ${YELLOW}‚Ä¢ Python Environment${NC}"
    fi
    
    if ! check_ollama 2>/dev/null; then
        SETUP_COMPLETE=false
        MISSING_ITEMS="${MISSING_ITEMS}\n   ${YELLOW}‚Ä¢ Ollama (KI-Laufzeit)${NC}"
    fi
    
    if [ ! -f "$PROJECT_ROOT/credentials.json" ]; then
        SETUP_COMPLETE=false
        MISSING_ITEMS="${MISSING_ITEMS}\n   ${YELLOW}‚Ä¢ Gmail OAuth Zugang${NC}"
    fi
    
    if [ ! -f "$PROJECT_ROOT/.env" ]; then
        SETUP_COMPLETE=false
        MISSING_ITEMS="${MISSING_ITEMS}\n   ${YELLOW}‚Ä¢ Konfiguration${NC}"
    fi
    
    # ASCII Art Header
    echo ""
    echo -e "${CYAN}    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}    ‚ïë                                                           ‚ïë${NC}"
    echo -e "${CYAN}    ‚ïë${NC}  ${BOLD}üìß  G M A I L   H E L P E R${NC}                              ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}    ‚ïë                                                           ‚ïë${NC}"
    echo -e "${CYAN}    ‚ïë${NC}   ${DIM}KI-gest√ºtzte E-Mail-Klassifizierung${NC}                    ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}    ‚ïë${NC}   ${DIM}Automatisches Labeling mit lokaler KI (Ollama)${NC}         ${CYAN}‚ïë${NC}"
    echo -e "${CYAN}    ‚ïë                                                           ‚ïë${NC}"
    echo -e "${CYAN}    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    
    # Systemanforderungen immer anzeigen
    show_system_requirements
    
    # Wenn Setup nicht komplett - KLARER HINWEIS
    if [ "$SETUP_COMPLETE" = false ]; then
        echo -e "   ${YELLOW}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "   ${YELLOW}‚ïë${NC}  üöÄ  ${BOLD}ERSTE SCHRITTE${NC}                                    ${YELLOW}‚ïë${NC}"
        echo -e "   ${YELLOW}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
        echo -e "   ${YELLOW}‚ïë${NC}                                                       ${YELLOW}‚ïë${NC}"
        echo -e "   ${YELLOW}‚ïë${NC}  Dies ist das erste Mal, dass du Gmail Helper       ${YELLOW}‚ïë${NC}"
        echo -e "   ${YELLOW}‚ïë${NC}  verwendest. F√ºhre zuerst die Einrichtung durch:    ${YELLOW}‚ïë${NC}"
        echo -e "   ${YELLOW}‚ïë${NC}                                                       ${YELLOW}‚ïë${NC}"
        echo -e "   ${YELLOW}‚ïë${NC}     ${BOLD}${CYAN}gmailhelper setup${NC}                                 ${YELLOW}‚ïë${NC}"
        echo -e "   ${YELLOW}‚ïë${NC}                                                       ${YELLOW}‚ïë${NC}"
        echo -e "   ${YELLOW}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo ""
        
        # Fehlende Komponenten anzeigen
        if [ -n "$MISSING_ITEMS" ]; then
            echo -e "   ${DIM}Folgende Komponenten werden eingerichtet:${NC}"
            echo -e "$MISSING_ITEMS"
            echo ""
        fi
        
        # Was macht setup?
        echo -e "   ${DIM}Das Setup installiert:${NC}"
        echo -e "   ${DIM}‚Ä¢ Ollama (lokale KI-Laufzeitumgebung)${NC}"
        echo -e "   ${DIM}‚Ä¢ KI-Modell mistral:7b-instruct (~4.4 GB Download)${NC}"
        echo -e "   ${DIM}‚Ä¢ Python Umgebung & Abh√§ngigkeiten${NC}"
        echo -e "   ${DIM}‚Ä¢ Gmail OAuth Verbindung${NC}"
        echo -e "   ${DIM}‚Ä¢ Konfiguration (.env)${NC}"
        echo ""
        
    else
        # Setup ist komplett - Schnellstart anzeigen
        echo -e "   ${GREEN}‚úÖ Einrichtung abgeschlossen${NC}\n"
        
        echo -e "   ${BOLD}Schnellstart:${NC}\n"
        
        echo -e "   ${CYAN}gmailhelper run --test${NC}"
        echo -e "      ${DIM}‚Üí Testlauf (zeigt an, setzt keine Labels)${NC}\n"
        
        echo -e "   ${CYAN}gmailhelper run --live${NC}"
        echo -e "      ${DIM}‚Üí Live-Betrieb (labels werden gesetzt)${NC}\n"
        
        echo -e "   ${CYAN}gmailhelper status${NC}"
        echo -e "      ${DIM}‚Üí System-Status anzeigen${NC}\n"
    fi
    
    # Alle Befehle
    echo -e "   ${BOLD}Alle verf√ºgbaren Befehle:${NC}\n"
    echo -e "   ${MAGENTA}setup${NC}          Erstinstallation durchf√ºhren"
    echo -e "   ${MAGENTA}setup --reset${NC}  Einstellungen √§ndern (Token bleibt)"
    echo -e "   ${MAGENTA}run --test${NC}     Test-Modus (Dry-Run, einmalig)"
    echo -e "   ${MAGENTA}run --live${NC}     Live-Dauerlauf (alle 30 Sekunden)"
    echo -e "   ${MAGENTA}stop${NC}           Alle laufenden Prozesse stoppen"
    echo -e "   ${MAGENTA}status${NC}         System-Status anzeigen"
    echo -e "   ${MAGENTA}help${NC}           Detaillierte Hilfe anzeigen"
    echo ""
}

show_status() {
    echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë                    Gmail Helper Status                           ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    
    # Python Venv
    echo -ne "üêç Python Venv:        "
    if [ -f "$VENV_PYTHON" ]; then
        echo -e "${GREEN}‚úÖ OK${NC}"
    else
        echo -e "${RED}‚ùå Fehlt${NC}"
    fi
    
    # Ollama Status
    echo -ne "ü§ñ Ollama:             "
    if check_ollama; then
        MODEL=$(get_ollama_model)
        echo -e "${GREEN}‚úÖ L√§uft${NC} (Modell: $MODEL)"
    else
        echo -e "${RED}‚ùå Nicht erreichbar${NC}"
        echo "                       Starten mit: ollama serve"
    fi
    
    # Laufende Gmail Helper Prozesse
    echo -ne "üìß Gmail Helper:       "
    RUNNING_PIDS=$(pgrep -f "(launcher\.py|app\.main)" 2>/dev/null || true)
    if [ -n "$RUNNING_PIDS" ]; then
        echo -e "${GREEN}‚úÖ L√§uft${NC} (PIDs: $RUNNING_PIDS)"
    else
        echo -e "${YELLOW}‚èπÔ∏è  Gestoppt${NC}"
    fi
    
    # Credentials
    echo -ne "üîë credentials.json:   "
    if [ -f "$PROJECT_ROOT/credentials.json" ]; then
        echo -e "${GREEN}‚úÖ Vorhanden${NC}"
    else
        echo -e "${RED}‚ùå Fehlt${NC}"
    fi
    
    echo -ne "üîì token.json:         "
    if [ -f "$PROJECT_ROOT/token.json" ]; then
        echo -e "${GREEN}‚úÖ Authentifiziert${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Fehlt${NC} (wird bei erstem Lauf erstellt)"
    fi
    
    # Config
    echo ""
    echo -e "${BLUE}‚öôÔ∏è  Konfiguration (.env):${NC}"
    if [ -f "$PROJECT_ROOT/.env" ]; then
        grep -E '^(OLLAMA|GMAIL|MAX|DRY|SET_LABEL|LOG_LEVEL)' "$PROJECT_ROOT/.env" 2>/dev/null | sed 's/^/   /' || echo "   (Standard-Werte werden verwendet)"
    else
        echo -e "   ${YELLOW}(Keine .env-Datei, Standard-Werte werden verwendet)${NC}"
    fi
    
    echo ""
    echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
}

# =============================================================================
# Hauptlogik
# =============================================================================

main() {
    COMMAND="${1:-}"
    
    # Wenn kein Command, zeige Willkommensbildschirm
    if [ -z "$COMMAND" ]; then
        show_welcome
        exit 0
    fi
    
    # Command "run" verarbeiten
    if [ "$COMMAND" = "run" ]; then
        
        # Command ist "run", pr√ºfe auf Flags
        shift || true
        
        # Parse flags
        MODE=""  # default: kein Modus
        EXTRA_ARGS=()
        
        while [ $# -gt 0 ]; do
            case "$1" in
                --test|-t)
                    MODE="test"
                    shift
                    ;;
                --live|-l)
                    MODE="live"
                    shift
                    ;;
                --ui)
                    echo -e "${RED}‚ùå UI-Modus wurde entfernt${NC}"
                    echo "   Verwende: gmailhelper run --test  oder  gmailhelper run --live"
                    exit 1
                    ;;
                --help|-h)
                    show_help
                    exit 0
                    ;;
                *)
                    EXTRA_ARGS+=("$1")
                    shift
                    ;;
            esac
        done
        
        check_venv
        
        # Pr√ºfe ob Mode gesetzt wurde
        if [ -z "$MODE" ]; then
            echo -e "${RED}‚ùå Fehler: Keine Option angegeben f√ºr 'run'${NC}"
            echo ""
            echo "Verwendung: gmailhelper run [OPTION]"
            echo ""
            echo "Optionen:"
            echo "  --test, -t     Test-Modus (Dry-Run, einmalig)"
            echo "  --live, -l     Live-Modus (Dauerlauf, setzt Labels)"
            echo ""
            echo "Beispiele:"
            echo "  gmailhelper run --test"
            echo "  gmailhelper run --live"
            exit 1
        fi
        
        case "$MODE" in
            test)
                # Test-Modus (Dry-Run, einmalig)
                echo -e "${YELLOW}üß™ Test-Modus (Dry-Run)${NC}"
                echo "   Es werden keine Labels gesetzt, nur angezeigt was passieren w√ºrde."
                echo ""
                
                if ! check_ollama; then
                    echo -e "${YELLOW}‚ö†Ô∏è  Warnung: Ollama nicht erreichbar unter localhost:11434${NC}"
                    echo "    Starte zuerst: ollama serve"
                    exit 1
                fi
                
                cd "$PROJECT_ROOT" && "$VENV_PYTHON" -m app.main --dry-run "${EXTRA_ARGS[@]}"
                ;;
                
            live)
                # Live-Modus (Dauerlauf)
                echo -e "${GREEN}üè∑Ô∏è  Live-Modus (Dauerlauf)${NC}"
                echo "   Labels werden wirklich gesetzt!"
                echo "   Pr√ºfung alle 30 Sekunden. Zum Beenden: Ctrl+C"
                echo ""
                
                if ! check_ollama; then
                    echo -e "${RED}‚ùå Fehler: Ollama nicht erreichbar unter localhost:11434${NC}"
                    echo "    Starte zuerst: ollama serve"
                    exit 1
                fi
                
                if [ ! -f "$PROJECT_ROOT/credentials.json" ]; then
                    echo -e "${RED}‚ùå Fehler: credentials.json nicht gefunden${NC}"
                    exit 1
                fi
                
                cd "$PROJECT_ROOT" && "$VENV_PYTHON" -m app.main --loop --interval 30 "${EXTRA_ARGS[@]}"
                ;;
        esac
        
    elif [ "$COMMAND" = "setup" ]; then
        # Parse setup flags
        shift || true
        SETUP_ARGS=()
        
        while [ $# -gt 0 ]; do
            case "$1" in
                --reset)
                    SETUP_ARGS+=("--reset")
                    shift
                    ;;
                *)
                    shift
                    ;;
            esac
        done
        
        # Setup: Verwende System-Python f√ºr den Anfang, da venv evtl. noch nicht existiert
        cd "$PROJECT_ROOT"
        if [ -f "$VENV_PYTHON" ]; then
            PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH" "$VENV_PYTHON" -m app.setup "${SETUP_ARGS[@]}"
        else
            # Fallback: System Python verwenden
            PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH" python3 -m app.setup "${SETUP_ARGS[@]}" 2>/dev/null || PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH" python -m app.setup "${SETUP_ARGS[@]}"
        fi
        
    elif [ "$COMMAND" = "stop" ]; then
        echo -e "${BLUE}üõë Stoppe Gmail Helper Prozesse...${NC}"
        echo ""
        
        # Finde und beende launcher.py Prozesse
        LAUNCHER_PIDS=$(pgrep -f "launcher\.py" 2>/dev/null || true)
        if [ -n "$LAUNCHER_PIDS" ]; then
            echo "   Beende UI (launcher.py): $LAUNCHER_PIDS"
            kill $LAUNCHER_PIDS 2>/dev/null || true
            sleep 1
            # Force kill falls noch l√§uft
            kill -9 $LAUNCHER_PIDS 2>/dev/null || true
        fi
        
        # Finde und beende app.main Prozesse
        MAIN_PIDS=$(pgrep -f "app\.main" 2>/dev/null || true)
        if [ -n "$MAIN_PIDS" ]; then
            echo "   Beende Hauptprogramm (app.main): $MAIN_PIDS"
            kill $MAIN_PIDS 2>/dev/null || true
            sleep 1
            # Force kill falls noch l√§uft
            kill -9 $MAIN_PIDS 2>/dev/null || true
        fi
        
        # Zus√§tzlich: Beende Python-Prozesse im Projektverzeichnis
        PYTHON_PIDS=$(ps aux | grep "$PROJECT_ROOT" | grep -E "(python|launcher)" | grep -v grep | awk '{print $2}' || true)
        if [ -n "$PYTHON_PIDS" ]; then
            echo "   Beende Python-Prozesse: $PYTHON_PIDS"
            kill $PYTHON_PIDS 2>/dev/null || true
            sleep 1
            kill -9 $PYTHON_PIDS 2>/dev/null || true
        fi
        
        echo ""
        echo -e "${GREEN}‚úÖ Gmail Helper wurde gestoppt${NC}"
        
    elif [ "$COMMAND" = "status" ] || [ "$COMMAND" = "st" ]; then
        show_status
        
    elif [ "$COMMAND" = "help" ] || [ "$COMMAND" = "-h" ] || [ "$COMMAND" = "--help" ]; then
        show_help
        
    else
        echo -e "${RED}‚ùå Unbekannter Befehl: $COMMAND${NC}"
        echo ""
        show_help
        exit 1
    fi
}

main "$@"
